<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Luke Irvine Collisions</title>

    <!-- Babylon.js -->
    <script src="https://code.jquery.com/pep/0.4.2/pep.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <!-- <script src="https://cdn.babylonjs.com/cannon.js"></script> -->
    <script src="https://cdn.babylonjs.com/Oimo.js"></script>

    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        // flag
        var simple = true;


        var canvas = document.getElementById("renderCanvas");

        var engine = null;
        var scene = null;
        var createDefaultEngine = function () { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true }); };

        var createScene = function () {

            // Create the scene space
            var scene = new BABYLON.Scene(engine);
            scene.collisionsEnabled = true;
            scene.enablePhysics(new BABYLON.Vector3(0, -50, 0), new BABYLON.OimoJSPlugin());

            // var options = new BABYLON.SceneOptimizerOptions();
            // // Optimizer
            // var optimizer = new BABYLON.SceneOptimizer(scene, options);
            // options.targetFrameRate(60);

            // textures
            var hedge = new BABYLON.StandardMaterial("hedge", scene);
            hedge.diffuseTexture = new BABYLON.Texture("textures/hedge.png", scene);
            hedge.specularTexture = new BABYLON.Texture("textures/hedge.png", scene);
            hedge.ambientTexture = new BABYLON.Texture("textures/hedge.png", scene);

            var grass = new BABYLON.StandardMaterial("grass", scene);
            grass.diffuseTexture = new BABYLON.Texture("textures/grass.jpg", scene);
            grass.specularTexture = new BABYLON.Texture("textures/grass.jpg", scene);
            grass.ambientTexture = new BABYLON.Texture("textures/grass.jpg", scene);

            var dirt = new BABYLON.StandardMaterial("grass", scene);
            dirt.diffuseTexture = new BABYLON.Texture("textures/cracked_dirt.jpg", scene);
            dirt.specularTexture = new BABYLON.Texture("textures/cracked_dirt.jpg", scene);
            dirt.ambientTexture = new BABYLON.Texture("textures/cracked_dirt.jpg", scene);

            // for spheres around sprites
            var pMat = new BABYLON.StandardMaterial("pMat", scene);
            pMat.emissiveColor = new BABYLON.Color3(1, 1, 0);
            pMat.alpha = 0.5;

            // camera
            var camera = new BABYLON.UniversalCamera("UniversalCamera", new BABYLON.Vector3(0, 10, -30), scene);
            camera.setTarget(new BABYLON.Vector3(0, 6, 0));
            camera.attachControl(canvas, true);
            camera.applyGravity = false;
            camera.ellipsoid = new BABYLON.Vector3(1, 4, 1);
            camera.checkCollisions = true;

            // lighting
            var light = new BABYLON.HemisphericLight("HemiLight", new BABYLON.Vector3(0, 100, 0), scene);

            // Ground
            var myGround = BABYLON.MeshBuilder.CreateGround("myGround", { width: 500, height: 500, subdivisions: 5 }, scene);
            myGround.material = dirt;
            myGround.checkCollisions = true;
            myGround.physicsImpostor = new BABYLON.PhysicsImpostor(
                myGround, BABYLON.PhysicsImpostor.BoxImpostor, 
                { mass: 0, restitution: 1, friction: 0 }, scene);
            // var tiledDirt = BABYLON.MeshBuilder.CreateTiledPlane("dirt", {width: 500, size: 500}, scene);

            // Wall
            var wall = new BABYLON.MeshBuilder.CreateBox("wall", { width: 50, height: 10, depth: 2 }, scene);
            wall.position.z = 10
            wall.checkCollisions = true;
            wall.material = dirt;
            wall.physicsImpostor = new BABYLON.PhysicsImpostor(
                wall, BABYLON.PhysicsImpostor.BoxImpostor, 
                { mass: 0, restitution: 0 }, scene);

            // Player Mesh
            var player = BABYLON.MeshBuilder.CreateBox("player", { width: 3, height: 6, depth: 3 }, scene);
            player.material = pMat;
            player.position.y = 3;
            player.ellipsoid = new BABYLON.Vector3(3, 7, 3);
            player.checkCollisions = true;
            player.applyGravity = true;
            player.speed = new BABYLON.Vector3(0, 0, 0.08);
            player.nextspeed = new BABYLON.Vector3.Zero();
            player.physicsImpostor = new BABYLON.PhysicsImpostor(
                player, BABYLON.PhysicsImpostor.SphereImpostor, 
                { mass: 150, restitution: 0, friction: 1 }, scene);

            // Sprites
            // Walking Thor
            var spriteManagerWalkingThor = new BABYLON.SpriteManager(
                "WalkingThorManager",
                "spritesheets/walking_thor.png",
                64, { width: 800 / 8, height: 800 / 8 }, scene
            );
            var walkingThor = new BABYLON.Sprite("walkingThor", spriteManagerWalkingThor);
            walkingThor.cellIndex = 0;
            walkingThor.size = 6;
            walkingThor.position.y = 3;
            walkingThor.position.x = 0;
            walkingThor.position.z = 0;

            // Trees
            // Create a sprite manager to optimize GPU ressources
            // Parameters : name, imgUrl, capacity, cellSize, scene
            var spriteManagerTrees = new BABYLON.SpriteManager("treesManager", "textures/pine.png", 2000, { width: 394, height: 537 }, scene);

            // Trees at random positions
            // for (var i = 0; i < 500; i++) {
            //     // mesh around trees
            //     var treeMesh = BABYLON.MeshBuilder.CreateSphere("treeMesh", { diameterY: 20, diameterX: 4, diameterZ: 4 }, scene);
            //     treeMesh.position.y = 7;
            //     treeMesh.material = pMat;
            //     treeMesh.ellipsoid = new BABYLON.Vector3(4, 10, 4);
            //     treeMesh.checkCollisions = true;
            //     // treeMesh.physicsImpostor = new BABYLON.PhysicsImpostor(treeMesh, BABYLON.PhysicsImpostor.SphereImpostor, {mass: 0, restitution: 0.1}, scene);

            //     var xSpot = Math.random() * 500 - 250;
            //     var ySpot = Math.random() * 500 - 250;

            //     tree = new BABYLON.Sprite("tree", spriteManagerTrees);
            //     tree.size = 20;
            //     tree.position.x = xSpot;
            //     tree.position.z = ySpot;
            //     treeMesh.position.x = xSpot;
            //     treeMesh.position.z = ySpot;
            //     tree.position.y = 7;
            //     tree.ellipsoid = new BABYLON.Vector3(5, 20, 5);
            //     tree.checkCollisions = true;
            // }

            /***********************************************************************************************************************************************************/

            // Keypress events
            window.keyisdown = {};
            window.addEventListener('keydown', function (event) {
                window.keyisdown[event.keyCode] = true;
            });

            window.addEventListener('keyup', function (event) {
                window.keyisdown[event.keyCode] = false;
            });

            window.tempv = new BABYLON.Vector3.Zero();

            // milliseconds between frames
            var delay = 63;
            // governs duration of jump
            var startJump = 7;
            var jump = startJump;

            scene.registerBeforeRender(function () {
                walkingThor.position = player.position;
                // Player speed
                var v = 0.5;
                player.nextspeed.x = 0.0;
                player.nextspeed.z = 0.00001;
                // Left "a"
                if (window.keyisdown[65] && !window.keyisdown[87] && !window.keyisdown[83]) {
                    player.nextspeed.x = -v;
                    if (walkingThor.cellIndex < 8 || walkingThor.cellIndex > 15) {
                        walkingThor.cellIndex = 8;
                    }
                    walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                    if (walkingThor.cellIndex > 15) {
                        walkingThor.cellIndex = 8;
                    }
                    sleep(delay);
                }
                // Right "d"
                if (window.keyisdown[68] && !window.keyisdown[87] && !window.keyisdown[83]) {
                    player.nextspeed.x = v;
                    if (walkingThor.cellIndex < 16 || walkingThor.cellIndex > 23) {
                        walkingThor.cellIndex = 16;
                    }
                    walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                    if (walkingThor.cellIndex > 23) {
                        walkingThor.cellIndex = 16;
                    }
                    sleep(delay);
                }
                // Up "w"
                if (window.keyisdown[87] && !window.keyisdown[65] && !window.keyisdown[68]) {
                    player.nextspeed.z = v;
                    if (walkingThor.cellIndex < 24 || walkingThor.cellIndex > 31) {
                        walkingThor.cellIndex = 24;
                    }
                    walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                    if (walkingThor.cellIndex > 31) {
                        walkingThor.cellIndex = 24;
                    }
                    sleep(delay);
                }
                // Down "s"
                if (window.keyisdown[83] && !window.keyisdown[65] && !window.keyisdown[68]) {
                    player.nextspeed.z = -v;
                    walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                    if (walkingThor.cellIndex > 7) {
                        walkingThor.cellIndex = 0;
                    }
                    sleep(delay);
                }

                // MultiDirectional

                // UpLeft
                if (window.keyisdown[65] && window.keyisdown[87]) {
                    player.nextspeed.x = -v;
                    player.nextspeed.z = v;
                    if (walkingThor.cellIndex < 40 || walkingThor.cellIndex > 47) {
                        walkingThor.cellIndex = 40;
                    }
                    walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                    if (walkingThor.cellIndex > 47) {
                        walkingThor.cellIndex = 40;
                    }
                    sleep(delay);
                }
                // UpRight
                if (window.keyisdown[68] && window.keyisdown[87]) {
                    player.nextspeed.x = v;
                    player.nextspeed.z = v;
                    if (walkingThor.cellIndex < 56) {
                        walkingThor.cellIndex = 56;
                    }
                    walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                    if (walkingThor.cellIndex == 63) {
                        walkingThor.cellIndex = 56;
                    }
                    sleep(delay)
                }
                // BottomRight
                if (window.keyisdown[68] && window.keyisdown[83]) {
                    player.nextspeed.x = v;
                    player.nextspeed.z = -v;
                    if (walkingThor.cellIndex < 48 || walkingThor.cellIndex > 55) {
                        walkingThor.cellIndex = 48;
                    }
                    walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                    if (walkingThor.cellIndex > 55) {
                        walkingThor.cellIndex = 48;
                    }
                    sleep(delay);
                }
                // BottomLeft
                if (window.keyisdown[65] && window.keyisdown[83]) {
                    player.nextspeed.x = -v;
                    player.nextspeed.z = -v;
                    if (walkingThor.cellIndex < 32 || walkingThor.cellIndex > 39) {
                        walkingThor.cellIndex = 32;
                    }
                    walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                    if (walkingThor.cellIndex > 39) {
                        walkingThor.cellIndex = 32;
                    }
                    sleep(delay);
                }

                player.speed = BABYLON.Vector3.Lerp(player.speed, player.nextspeed, 0.1);

                // Turn to direction
                if (player.speed.length() > 0.01) {
                    tempv.copyFrom(player.speed);
                    var dot = BABYLON.Vector3.Dot(tempv.normalize(), BABYLON.Axis.Z);
                    var al = Math.acos(dot);
                    if (tempv.x < 0.0) { al = Math.PI * 2.0 - al; }
                    if (window.keyisdown[9]) {
                        console.log("dot,al:", dot, al);
                    }
                    if (al > player.rotation.y) {
                        var t = Math.PI / 30;
                    } else {
                        var t = -Math.PI / 30;
                    }
                    var ad = Math.abs(player.rotation.y - al);
                    if (ad > Math.PI) {
                        t = -t;
                    }
                    if (ad < Math.PI / 15) {
                        t = 0;
                    }
                    player.rotation.y += t;
                    if (player.rotation.y > Math.PI * 2) { player.rotation.y -= Math.PI * 2; }
                    if (player.rotation.y < 0) { player.rotation.y += Math.PI * 2; }
                }

                player.moveWithCollisions(player.speed);

                if (player.position.x > 250) { player.position.x = 250; }
                if (player.position.x < -250) { player.position.x = -250; }
                if (player.position.z > 250) { player.position.z = 250; }
                if (player.position.z < -250) { player.position.z = -250; }
                if (window.keyisdown[32]) {
                    jump -= 1;
                    if (jump > 0) {
                        player.applyImpulse(new BABYLON.Vector3(0, 4, 0), player.getAbsolutePosition());
                    }
                }
                if (!window.keyisdown[32]) {
                    jump = startJump;
                }

                // player.nexttorch = lightImpostor.getAbsolutePosition();
                // torch.position.copyFrom(player.nexttorch);
                // torch.intensity = 0.7 + Math.random() * 0.1;
                // torch.position.x += Math.random() * 0.125 - 0.0625;
                // torch.position.z += Math.random() * 0.125 - 0.0625;
                // camera.target = player;
            });


            // // Key Controls
            // /****************************Key Control Multiple Keys************************************************/

            // var map = {}; //object for multiple key presses
            // scene.actionManager = new BABYLON.ActionManager(scene);

            // scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, function (evt) {
            //     map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";

            // }));

            // scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, function (evt) {
            //     map[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
            // }));

            // /****************************Move Sprite******************************************************/

            // scene.registerAfterRender(function () {
            //     walkingThor.position = player.position;

            //     if ((map["w"] && !map["a"] && !map["d"])) {
            //         player.position.z += 0.2;
            //         if (walkingThor.cellIndex < 24 || walkingThor.cellIndex > 31) {
            //             walkingThor.cellIndex = 24;
            //         }
            //         walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
            //         if (walkingThor.cellIndex > 31) {
            //             walkingThor.cellIndex = 24;
            //         }
            //     };

                // if ((map["s"] && !map["a"] && !map["d"])) {
                //     player.position.z -= 0.2;
                //     walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
                //     if (walkingThor.cellIndex > 7) {
                //         walkingThor.cellIndex = 0;
                //     }
                // };

            //     if ((map["a"] && !map["w"] && !map["s"])) {
            //         player.position.x -= 0.2;
            //         if (walkingThor.cellIndex < 8 || walkingThor.cellIndex > 15) {
            //             walkingThor.cellIndex = 8;
            //         }
            //         walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
            //         if (walkingThor.cellIndex > 15) {
            //             walkingThor.cellIndex = 8;
            //         }
            //     };

            //     if ((map["d"] && !map["w"] && !map["s"])) {
            //         player.position.x += 0.2;
            //         if (walkingThor.cellIndex < 16 || walkingThor.cellIndex > 23) {
            //             walkingThor.cellIndex = 16;
            //         }
            //         walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
            //         if (walkingThor.cellIndex > 23) {
            //             walkingThor.cellIndex = 16;
            //         }
            //     };

            //     if ((map["w"] && map["a"])) {
            //         player.position.x -= 0.1414214;
            //         player.position.z += 0.1414214;
            //         if (walkingThor.cellIndex < 40 || walkingThor.cellIndex > 47) {
            //             walkingThor.cellIndex = 40;
            //         }
            //         walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
            //         if (walkingThor.cellIndex > 47) {
            //             walkingThor.cellIndex = 40;
            //         }
            //     }

            //     if ((map["w"] && map["d"])) {
            //         player.position.x += 0.1414214;
            //         player.position.z += 0.1414214;
            //         if (walkingThor.cellIndex < 56) {
            //             walkingThor.cellIndex = 56;
            //         }
            //         walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
            //         if (walkingThor.cellIndex == 63) {
            //             walkingThor.cellIndex = 56;
            //         }
            //     }

            //     if ((map["a"] && map["s"])) {
            //         player.position.x -= 0.1414214;
            //         player.position.z -= 0.1414214;
            //         if (walkingThor.cellIndex < 32 || walkingThor.cellIndex > 39) {
            //             walkingThor.cellIndex = 32;
            //         }
            //         walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
            //         if (walkingThor.cellIndex > 39) {
            //             walkingThor.cellIndex = 32;
            //         }
            //     }

            //     if ((map["s"] && map["d"])) {
            //         player.position.x += 0.1414214;
            //         player.position.z -= 0.1414214;
            //         if (walkingThor.cellIndex < 48 || walkingThor.cellIndex > 55) {
            //             walkingThor.cellIndex = 48;
            //         }
            //         walkingThor.cellIndex = (walkingThor.cellIndex + 1) % 64;
            //         if (walkingThor.cellIndex > 55) {
            //             walkingThor.cellIndex = 48;
            //         }
            //     }

            // });

            // /********************************************************************************************/




            return scene;
        }

        function sleep(milliseconds) {
            const date = Date.now();
            let currentDate = null;
            do {
                currentDate = Date.now();
            } while (currentDate - date < milliseconds);
        }



        engine = createDefaultEngine();
        if (!engine) throw 'engine should not be null.';
        scene = createScene();

        engine.runRenderLoop(function () {
            if (scene) {
                scene.render();
            }
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>

</html>